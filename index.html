<!-- tracker.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lecture Tracker</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
        :root {
            --nvidia-green: #76b900;
            --dark-bg: #111;
            --card-bg: #1f1f1f;
            --text: #e9e9e9;
            --muted: #999;
            --radius: 10px;
        }
        body { background: var(--dark-bg); color: var(--text); font-family: Inter, system-ui, sans-serif; padding:20px; }
        .container { max-width:1100px; margin:0 auto; }
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        h1 { color: var(--nvidia-green); }
        .card { background: var(--card-bg); border-radius:var(--radius); padding:18px; margin-bottom:16px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .grid { display:grid; grid-template-columns: 1fr 380px; gap:20px; }
        .small-grid { display:grid; grid-template-columns: repeat(2,1fr); gap:12px; }
        input, button, select { padding:10px; border-radius:8px; border:1px solid #333; background:#121212; color:var(--text); }
        button.primary { background:var(--nvidia-green); color:#000; border:none; font-weight:700; }
        .center { text-align:center; }
        .progress-circle { width:140px; height:140px; margin:0 auto; position:relative; }
        .circle-text { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); font-size:20px; font-weight:700; }
        ul.records { list-style:none; padding:0; margin:0; max-height:300px; overflow:auto; }
        ul.records li { display:flex; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #222; }
        label { display:block; margin-bottom:6px; color:var(--muted); }
        .inline { display:flex; gap:8px; align-items:center; }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div><h1><i class="fas fa-chart-line"></i> Lecture Tracker</h1><div style="color:var(--muted)">Class 11 & 12</div></div>
        <div id="loginBlock" class="card">
            <div style="width:320px;">
                <div style="margin-bottom:8px"><strong>Login</strong></div>
                <label>Username</label>
                <input id="username" placeholder="Username" value="RYUK"/>
                <label style="margin-top:8px">Password</label>
                <input id="password" type="password" placeholder="Password" value="THAD1560"/>
                <div style="display:flex; gap:8px; margin-top:10px;">
                    <button id="loginBtn" class="primary">Login</button>
                </div>
            </div>
        </div>
    </header>

    <div id="dashboard" style="display:none;">
        <div class="grid">
            <div>
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <strong>Submit Today's Progress</strong>
                            <div style="color:var(--muted); font-size:13px;">Submit once per day to count streak</div>
                        </div>
                        <div id="streakBox" class="center">
                            <div style="color:var(--muted); font-size:12px;">Streak</div>
                            <div id="streakCount" style="font-size:22px; color:var(--nvidia-green);">0</div>
                        </div>
                    </div>

                    <div style="display:flex; gap:18px; margin-top:16px; align-items:center;">
                        <div style="flex:0 0 160px;">
                            <div class="progress-circle card">
                                <svg width="140" height="140" viewBox="0 0 120 120">
                                    <circle cx="60" cy="60" r="54" stroke="#333" stroke-width="8" fill="none"></circle>
                                    <circle id="todayCircleSVG" cx="60" cy="60" r="54" stroke="#76b900" stroke-width="8" fill="none" stroke-linecap="round" transform="rotate(-90 60 60)"></circle>
                                </svg>
                                <div class="circle-text" id="todayCircleText">0</div>
                            </div>
                        </div>

                        <div style="flex:1;">
                            <label>Class</label>
                            <select id="todayClass">
                                <option value="12">12th</option>
                                <option value="11">11th</option>
                            </select>

                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <div style="flex:1;">
                                    <label>Lectures done today</label>
                                    <input type="number" id="todayLectures" min="0" value="0"/>
                                </div>
                                <div style="flex:1;">
                                    <label>DPP done today</label>
                                    <input type="number" id="todayDpp" min="0" value="0"/>
                                </div>
                            </div>

                            <div style="margin-top:12px; display:flex; gap:8px;">
                                <button class="primary" onclick="submitToday()">Submit</button>
                                <button onclick="fetchDailyRecords()">Refresh Records</button>
                            </div>

                            <div style="margin-top:12px; color:var(--muted); font-size:13px;">
                                Note: Streak increments only if you submit (lectures>0 or dpp>0) for the day.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top:12px;">
                    <strong>Daily Records</strong>
                    <div style="margin-top:8px;">
                        <label>Show records for</label>
                        <select id="recordsClass">
                            <option value="">All classes</option>
                            <option value="12">12th</option>
                            <option value="11">11th</option>
                        </select>
                        <div style="margin-top:8px;">
                            <ul id="dailyList" class="records"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <div class="card">
                    <strong>Progress Graph</strong>
                    <div style="margin-top:12px;">
                        <canvas id="progressChart" height="260"></canvas>
                    </div>
                </div>

                <div class="card" style="margin-top:12px;">
                    <strong>Quick Controls / Admin (UI)</strong>
                    <div style="margin-top:8px;">
                        <label>Admin actions (use carefully)</label>
                        <div style="display:flex; gap:8px; margin-top:8px;">
                            <input id="admUserId" placeholder="user_id" />
                            <button onclick="loadMyUserId()">Use my ID</button>
                        </div>

                        <div style="margin-top:8px;">
                            <small style="color:var(--muted)">Set values for 12th (maths/physics/chemistry/class12)</small>
                            <div class="small-grid" style="margin-top:8px;">
                                <input id="admin-maths-lectures" placeholder="maths lectures (12)" type="number"/>
                                <input id="admin-maths-dpp" placeholder="maths dpp (12)" type="number"/>
                                <input id="admin-physics-lectures" placeholder="physics lectures (12)" type="number"/>
                                <input id="admin-physics-dpp" placeholder="physics dpp (12)" type="number"/>
                                <input id="admin-chem-lectures" placeholder="chem lectures (12)" type="number"/>
                                <input id="admin-chem-dpp" placeholder="chem dpp (12)" type="number"/>
                            </div>
                            <div style="margin-top:8px;">
                                <button onclick="adminUpdate12()" class="primary">Update 12th</button>
                            </div>
                        </div>

                        <div style="margin-top:12px;">
                            <small style="color:var(--muted)">Set values for 11th (maths11/physics11/chemistry11/class11)</small>
                            <div class="small-grid" style="margin-top:8px;">
                                <input id="admin-m11-lectures" placeholder="maths11 lectures" type="number"/>
                                <input id="admin-m11-dpp" placeholder="maths11 dpp" type="number"/>
                                <input id="admin-p11-lectures" placeholder="physics11 lectures" type="number"/>
                                <input id="admin-p11-dpp" placeholder="physics11 dpp" type="number"/>
                                <input id="admin-c11-lectures" placeholder="chem11 lectures" type="number"/>
                                <input id="admin-c11-dpp" placeholder="chem11 dpp" type="number"/>
                            </div>
                            <div style="margin-top:8px;">
                                <button onclick="adminUpdate11()" class="primary">Update 11th</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let loggedUserId = null;
let chart = null;

// Helper to draw the circular progress on the left
function setTodayCircle(val) {
    const radius = 54;
    const circumference = 2 * Math.PI * radius;
    const percent = Math.min(100, val); // value used to show combined progress for demo
    const offset = circumference - (percent / 100) * circumference;
    const circle = document.getElementById('todayCircleSVG');
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    circle.style.strokeDashoffset = offset;
    document.getElementById('todayCircleText').textContent = val;
}

// Login flow
document.getElementById('loginBtn').addEventListener('click', async () => {
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    if(!username || !password) return alert('Enter credentials');

    const res = await fetch('/api/login', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({username, password})
    });
    const js = await res.json();
    if(js.success) {
        loggedUserId = js.user_id;
        document.getElementById('loginBlock').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        document.getElementById('admUserId').value = loggedUserId;
        fetchStreak();
        fetchDailyRecords();
        loadChart();
    } else {
        alert('Login failed: ' + (js.message || ''));
    }
});

function loadMyUserId(){
    if(loggedUserId) document.getElementById('admUserId').value = loggedUserId;
}

// Submit today's progress
async function submitToday(){
    if(!loggedUserId) return alert('Login first');

    const cls = document.getElementById('todayClass').value;
    const lectures = parseInt(document.getElementById('todayLectures').value || 0);
    const dpp = parseInt(document.getElementById('todayDpp').value || 0);

    if(lectures <= 0 && dpp <= 0) {
        if(!confirm('You are submitting 0. Do you want to continue?')) return;
    }

    const res = await fetch('/api/submit_daily', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: loggedUserId, class_level: parseInt(cls), lectures, dpp })
    });
    const js = await res.json();
    if(js.success) {
        alert('Submitted');
        // update circle value showing combined (lectures+dpp) for a quick visual
        setTodayCircle(lectures + dpp);
        fetchStreak();
        fetchDailyRecords();
        updateChart(); // refresh graph
    } else {
        alert('Error: ' + (js.message || ''));
    }
}

// Fetch daily records
async function fetchDailyRecords(){
    if(!loggedUserId) return;
    const classFilter = document.getElementById('recordsClass').value;
    const params = new URLSearchParams({ user_id: loggedUserId });
    if(classFilter) params.append('class_level', classFilter);
    const res = await fetch('/api/daily_records?' + params.toString());
    const js = await res.json();
    const ul = document.getElementById('dailyList');
    ul.innerHTML = '';
    if(js.success) {
        js.records.forEach(r => {
            const li = document.createElement('li');
            li.innerHTML = `<div>${r.date} <small style="color:var(--muted)">class ${r.class_level}</small></div>
                            <div style="min-width:120px; text-align:right;"><strong>${r.lectures}</strong> lec &nbsp; <strong>${r.dpp}</strong> dpp</div>`;
            ul.appendChild(li);
        });
    }
}

// Fetch streak
async function fetchStreak(){
    if(!loggedUserId) return;
    const res = await fetch('/api/streak?user_id=' + loggedUserId);
    const js = await res.json();
    if(js.success) {
        document.getElementById('streakCount').textContent = (js.streak || 0) + ' days';
    }
}

// Admin update 12th
async function adminUpdate12(){
    const uid = parseInt(document.getElementById('admUserId').value || 0);
    if(!uid) return alert('Set user id');

    const updates = {};
    const mappings = [
        ['maths-lectures','admin-maths-lectures'], ['maths-dpp','admin-maths-dpp'],
        ['physics-lectures','admin-physics-lectures'], ['physics-dpp','admin-physics-dpp'],
        ['chemistry-lectures','admin-chem-lectures'], ['chemistry-dpp','admin-chem-dpp'],
    ];
    mappings.forEach(([key, id])=>{
        const v = document.getElementById(id).value;
        if(v !== '') updates[key] = parseInt(v);
    });

    if(Object.keys(updates).length === 0) return alert('No values provided');
    const res = await fetch('/api/admin/update_12th', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: uid, updates })
    });
    const js = await res.json();
    alert(js.message || 'Done');
}

// Admin update 11th
async function adminUpdate11(){
    const uid = parseInt(document.getElementById('admUserId').value || 0);
    if(!uid) return alert('Set user id');

    const updates = {};
    const mappings = [
        ['maths11-lectures','admin-m11-lectures'], ['maths11-dpp','admin-m11-dpp'],
        ['physics11-lectures','admin-p11-lectures'], ['physics11-dpp','admin-p11-dpp'],
        ['chemistry11-lectures','admin-c11-lectures'], ['chemistry11-dpp','admin-c11-dpp'],
    ];
    mappings.forEach(([key, id])=>{
        const v = document.getElementById(id).value;
        if(v !== '') updates[key] = parseInt(v);
    });

    if(Object.keys(updates).length === 0) return alert('No values provided');
    const res = await fetch('/api/admin/update_11th', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ user_id: uid, updates })
    });
    const js = await res.json();
    alert(js.message || 'Done');
}

/* Chart functions */
async function loadChart(){
    const ctx = document.getElementById('progressChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'bar',
        data: { labels: [], datasets: [
            { label: 'Lectures', data: [], stack: 'a', backgroundColor: 'rgba(118,185,0,0.9)' },
            { label: 'DPP', data: [], stack: 'a', backgroundColor: 'rgba(255,255,255,0.95)' }
        ]},
        options: {
            responsive:true,
            scales: {
                x: { stacked: true },
                y: { stacked: true, beginAtZero:true }
            },
            plugins: {
                legend: { labels: { color: '#fff' } }
            }
        }
    });
    updateChart();
}

async function updateChart(){
    if(!loggedUserId) return;
    // fetch last 20 daily records (all classes combined)
    const res = await fetch('/api/daily_records?user_id=' + loggedUserId);
    const js = await res.json();
    if(!js.success) return;
    const records = js.records.slice(0, 30).reverse(); // oldest -> newest
    const labels = records.map(r => r.date);
    const lectures = records.map(r => r.lectures);
    const dpps = records.map(r => r.dpp);

    chart.data.labels = labels;
    chart.data.datasets[0].data = lectures;
    chart.data.datasets[1].data = dpps;
    chart.update();
}

/* wire recordsClass change to refresh */
document.getElementById('recordsClass').addEventListener('change', fetchDailyRecords);

</script>
</body>
</html>
